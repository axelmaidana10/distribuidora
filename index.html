<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Log√≠stica - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .header { background: #4f46e5; color: white; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 40; }
        .header-container { max-width: 80rem; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 1.875rem; font-weight: bold; margin: 0; }
        .header-subtitle { font-size: 0.875rem; color: #c7d2fe; margin: 0; }
        .header-user-info { text-align: right; }
        .header-user-text { font-size: 0.875rem; margin: 0; }
        .header-button { margin-top: 0.5rem; background: #6366f1; color: white; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; border: none; cursor: pointer; transition: background 0.2s; }
        .header-button:hover { background: #4338ca; }

        .card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-primary { background: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary:hover { background: #4338ca; }
        .btn-success { background: #16a34a; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; }
        .btn-success:hover { background: #15803d; }
        .btn-danger { background: #dc2626; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; }
        .btn-danger:hover { background: #b91c1c; }
        .tab-active { background: #4f46e5; color: white; }
        .tab-inactive { background: #e5e7eb; color: #374151; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .password-container { position: relative; display: flex; align-items: center; }
    </style>
    <style>
        @media print {
            /* Ocultar todo el cuerpo por defecto */
            body > * {
                display: none !important;
            }
            /* Hacer visible solo el modal de la boleta y su contenido */
            #boletaModal, #boletaModal * {
                display: block !important;
            }
            /* Ajustar el modal para que ocupe toda la p√°gina de impresi√≥n */
            #boletaModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- HEADER -->
<header class="header">
    <div class="header-container">
        <div>
            <h1 class="header-title">üì¶ Distribuidora Urbans</h1>
            <p id="roleDisplay" class="header-subtitle">Cargando...</p>
        </div>
        <div class="header-user-info">
            <p id="userDisplay" class="header-user-text">Usuario: -</p>
            <button id="logoutButton" onclick="handleLogout()" class="header-button" style="display: none;">Cerrar Sesi√≥n</button>
        </div>
    </div>
</header>

<!-- MAIN CONTENT -->
<main style="max-width: 80rem; margin: 0 auto; padding: 1.5rem;">
    <!-- ADMIN VIEW -->
    <div id="adminView" style="display: none;">
        <h2 style="font-size: 1.875rem; font-weight: bold; color: #1e1b4b; margin-bottom: 1.5rem;">Panel de Administraci√≥n</h2>
        
        <div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; border-bottom: 1px solid #e5e7eb; overflow-x: auto; padding-bottom: 0;">
            <button onclick="switchTab('resumen')" class="adminTab tab-active" data-tab="resumen" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer;">üìä Resumen</button>
            <button onclick="switchTab('pedidos')" class="adminTab tab-inactive" data-tab="pedidos" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer;">üìã Pedidos</button>
            <button onclick="switchTab('rutas')" class="adminTab tab-inactive" data-tab="rutas" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer;">üìç Rutas</button>
            <button onclick="switchTab('productos')" class="adminTab tab-inactive" data-tab="productos" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer;">üì¶ Productos</button>
            <button onclick="switchTab('clientes')" class="adminTab tab-inactive" data-tab="clientes" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer;">üë• Clientes</button>
            <button onclick="switchTab('preventistas')" class="adminTab tab-inactive" data-tab="preventistas" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer;">üöó Preventistas</button>
            <button onclick="switchTab('clientes-sin-asignar')" class="adminTab tab-inactive" data-tab="clientes-sin-asignar" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer;">üë§ Clientes Sin Asignar</button>
        </div>

        <!-- RUTAS TAB -->
        <div id="tab-rutas" class="tab-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">üìç Crear Nueva Ruta</h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Preventista</label>
                    <select id="routePreventistaSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;"></select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Pedidos Seleccionados</label>
                    <div id="selectedOrdersList" style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb; max-height: 160px; overflow-y: auto; min-height: 80px; font-size: 0.875rem;">Ninguno</div>
                </div>
                <button onclick="createRoute()" class="btn-success" style="width: 100%; font-size: 0.875rem;">Asignar Ruta</button>
            </div>
            
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #b45309; margin-bottom: 1rem;">‚è±Ô∏è Pedidos Pendientes</h3>
                <div id="pendingOrdersList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;"></div>
            </div>
            
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #1e40af; margin-bottom: 1rem;">üöö Rutas Asignadas</h3>
                <div id="routesList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;"></div>
            </div>
        </div>

        <!-- PRODUCTOS TAB -->
        <div id="tab-productos" class="tab-content" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div class="card">
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">Agregar Producto</h3>
                    <input type="text" id="productName" placeholder="Nombre" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <input type="number" id="productPrice" placeholder="Precio" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;" step="0.01" min="0">
                    <input type="number" id="productStock" placeholder="Stock inicial" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;" min="0">
                    <input type="text" id="productImageUrl" placeholder="URL de la imagen (opcional)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
                    <button onclick="addProduct()" class="btn-primary" style="width: 100%; font-size: 0.875rem;">Subir Producto</button>
                </div>
                <div class="card" style="grid-column: span 2;">
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">Cat√°logo</h3>
                    <div id="productsList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;"></div>
                </div>
            </div>
        </div>

        <!-- CLIENTES TAB -->
        <div id="tab-clientes" class="tab-content" style="display: none;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">Lista de Clientes</h3>
                <input type="text" id="clientSearch" onkeyup="filterClients()" placeholder="üîç Buscar cliente por nombre o zona..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
                <div id="clientsList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;"></div>
            </div>
        </div>

        <!-- PREVENTISTAS TAB -->
        <div id="tab-preventistas" class="tab-content" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div class="card">
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">Crear Preventista</h3>
                    <input type="text" id="preventistName" placeholder="Nombre" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <input type="text" id="preventistDni" placeholder="DNI" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <input type="text" id="preventistPhone" placeholder="Tel√©fono" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <input type="text" id="preventistZone" placeholder="Zona (ej: ZONA-1)" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                    <input type="email" id="preventistEmail" placeholder="Email" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
                    <div class="password-container" style="margin-bottom: 0.75rem;">
                        <input type="password" id="preventistPassword" placeholder="Contrase√±a" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                        <button id="togglePasswordBtn" onclick="togglePasswordVisibility()" type="button" style="position: absolute; right: 0.5rem; background: none; border: none; cursor: pointer; color: #6b7280;">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: -0.5rem; margin-bottom: 0.75rem;">M√≠nimo 8 caracteres, una may√∫scula, una min√∫scula y un n√∫mero.</p>
                    <button onclick="addPreventista()" class="btn-primary" style="width: 100%; font-size: 0.875rem;">Crear</button>
                </div>
                <div class="card" style="grid-column: span 2;">
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">Preventistas</h3>
                    <div id="preventistasList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;"></div>
                </div>
            </div>
        </div>

        <!-- CLIENTES SIN ASIGNAR TAB -->
        <div id="tab-clientes-sin-asignar" class="tab-content" style="display: none;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">Clientes Sin Asignar</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Aqu√≠ puedes ver los clientes que no est√°n asignados a ning√∫n preventista y reasignarlos.</p>
                <div id="unassignedClientsList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;"></div>
            </div>
        </div>

        <!-- PEDIDOS TAB -->
        <div id="tab-pedidos" class="tab-content" style="display: none;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; color: #4338ca; margin-bottom: 1rem;">Pedidos Recibidos</h3>
                <div id="ordersList" style="max-height: 500px; overflow-y: auto; font-size: 0.875rem; display: flex; flex-direction: column; gap: 0.75rem;"></div>
            </div>
        </div>

        <!-- RESUMEN TAB -->
        <div id="tab-resumen" class="tab-content" style="display: block;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="card">
                    <h4 style="font-size: 0.875rem; color: #6b7280; font-weight: 600; margin: 0;">VENTA SEMANAL</h4>
                    <p id="weeklySales" style="font-size: 2.25rem; font-weight: bold; color: #16a34a; margin: 0.5rem 0 0 0;">$0.00</p>
                </div>
                <div class="card">
                    <h4 style="font-size: 0.875rem; color: #6b7280; font-weight: 600; margin: 0;">VENTA MENSUAL</h4>
                    <p id="monthlySales" style="font-size: 2.25rem; font-weight: bold; color: #16a34a; margin: 0.5rem 0 0 0;">$0.00</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem;">
                <div class="card">
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #b45309; margin-bottom: 1rem;">‚ö†Ô∏è Alertas de Bajo Stock</h3>
                    <div id="lowStockList" style="max-height: 384px; overflow-y: auto; font-size: 0.875rem;">
                        <p style="color: #6b7280;">No hay productos con bajo stock.</p>
                    </div>
                </div>
                <div class="card">
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #1e40af; margin-bottom: 1rem;">üì¶ Inventario General</h3>
                    <div id="inventoryList" style="max-height: 384px; overflow-y: auto; font-size: 0.875rem;">
                        <!-- El inventario se cargar√° aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PREVENTISTA VIEW -->
    <div id="preventistaView" style="display: none;">
        <h2 style="font-size: 1.875rem; font-weight: bold; color: #1e40af; margin-bottom: 1.5rem;">Panel de Preventista</h2>
        <div style="display: flex; gap: 0.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0;">
            <button onclick="switchTab('nuevo-pedido')" class="prevTab tab-active" data-tab="nuevo-pedido" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; border: none; cursor: pointer; background: #4f46e5; color: white;">üìù Nuevo Pedido</button>
            <button onclick="switchTab('mis-pedidos')" class="prevTab tab-inactive" data-tab="mis-pedidos" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; border: none; cursor: pointer; background: #e5e7eb; color: #374151;">üìã Mis Pedidos</button>
            <button onclick="switchTab('mis-clientes')" class="prevTab tab-inactive" data-tab="mis-clientes" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; border: none; cursor: pointer; background: #e5e7eb; color: #374151;">üë• Mis Clientes</button>
            <button onclick="switchTab('catalogo')" class="prevTab tab-inactive" data-tab="catalogo" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; border: none; cursor: pointer; background: #e5e7eb; color: #374151;">üì¶ Cat√°logo Completo</button>
            <button onclick="switchTab('mi-perfil')" class="prevTab tab-inactive" data-tab="mi-perfil" style="padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; border: none; cursor: pointer; background: #e5e7eb; color: #374151;">üë§ Mi Perfil</button>
            
        </div>

        <div id="tab-mis-clientes" class="tab-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold;">Mis Clientes</h3>
                <div id="myClientsList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; font-size: 0.875rem;"></div>
            </div>
            <div class="card" style="grid-column: span 2;">
                <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Crear Nuevo Cliente</h3>
                <input type="text" id="newClientName" placeholder="Nombre del negocio" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                <input type="text" id="newClientAddress" placeholder="Direcci√≥n" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.5rem; font-size: 0.875rem;">
                <input type="tel" id="newClientPhone" placeholder="Tel√©fono" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
                <button onclick="createClient()" class="btn-success" style="width: 100%; font-size: 0.875rem;">Crear Cliente</button>
            </div>
        </div>

        <!-- MI PERFIL TAB (PREVENTISTA) -->
        <div id="tab-mi-perfil" class="tab-content" style="display: none; margin-top: 1.5rem;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Mi Perfil</h3>
                <div id="myProfileDetails" style="font-size: 1rem; display: flex; flex-direction: column; gap: 0.75rem;"></div>
            </div>
        </div>

        <div id="tab-catalogo" class="tab-content" style="display: none; margin-top: 1.5rem;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Productos Disponibles</h3>
                <div id="catalogoList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;"></div>
            </div>
        </div>

        <div id="tab-mis-pedidos" class="tab-content" style="display: none; margin-top: 1.5rem;">
            <div class="card">
                <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Mis Pedidos Realizados</h3>
                <div id="myOrdersList" style="max-height: 384px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; font-size: 0.875rem;"></div>
            </div>
        </div>

        <!-- NUEVO PEDIDO TAB -->
        <div id="tab-nuevo-pedido" class="tab-content" style="display: block; margin-top: 1.5rem;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                <!-- Columna de Cat√°logo -->
                <div class="card" style="grid-column: span 2;">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">1. Seleccionar Productos</h3>
                    <input type="text" id="productSearch" onkeyup="filterProducts()" placeholder="üîç Buscar producto..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
                    <div id="orderCatalogList" style="max-height: 400px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;"></div>
                </div>
                <!-- Columna de Resumen de Pedido -->
                <div class="card">
                    <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">2. Resumen del Pedido</h3>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Cliente</label>
                    <select id="orderClientSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; margin-bottom: 1rem;"></select>
                    <div id="orderSummaryList" style="max-height: 220px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background: #f9fafb; margin-bottom: 1rem; font-size: 0.875rem;"><p style="color: #6b7280;">Agrega productos del cat√°logo.</p></div>
                    <p style="font-size: 1.125rem; font-weight: bold; text-align: right; margin-bottom: 1rem;">Total: <span id="orderTotal">$0.00</span></p>
                    <button onclick="submitOrder()" class="btn-success" style="width: 100%; font-size: 0.875rem;">‚úì Finalizar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BOLETA MODAL -->
    <div id="boletaModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50;">
        <div class="card" style="max-width: 36rem; width: 100%; margin: 0 1rem; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 1rem;">
                <h2 style="font-size: 1.5rem; font-weight: bold;">Detalle del Pedido</h2>
                <button onclick="closeBoletaModal()" style="background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #9ca3af;">&times;</button>
            </div>
            <div id="boletaContent" style="flex-grow: 1; overflow-y: auto; font-size: 0.875rem;">
                <!-- El contenido de la boleta se inyectar√° aqu√≠ -->
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;" class="no-print">
                <button onclick="window.print()" class="btn-success" style="width: 100%;">Imprimir</button>
                <button onclick="closeBoletaModal()" class="btn-primary" style="width: 100%; background: #6b7280;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- EDIT PRODUCT MODAL -->
    <div id="editProductModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50;">
        <div class="card" style="max-width: 28rem; width: 100%; margin: 0 1rem;">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Editar Producto</h2>
            <input type="hidden" id="editProductId">
            <label class="form-label" for="editProductName">Nombre</label>
            <input type="text" id="editProductName" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <label class="form-label" for="editProductPrice">Precio</label>
            <input type="number" id="editProductPrice" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;" step="0.01" min="0">
            <label class="form-label" for="editProductStock">Stock</label>
            <input type="number" id="editProductStock" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;" min="0">
            <label class="form-label" for="editProductImageUrl">URL de la Imagen</label>
            <input type="text" id="editProductImageUrl" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
            <button onclick="updateProduct()" class="btn-success" style="width: 100%; font-size: 0.875rem; margin-bottom: 0.5rem;">Guardar Cambios</button>
            <button onclick="closeEditProductModal()" class="btn-primary" style="width: 100%; background: #6b7280; font-size: 0.875rem;">Cancelar</button>
        </div>
    </div>

    <!-- EDIT CLIENT MODAL -->
    <div id="editClientModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50;">
        <div class="card" style="max-width: 28rem; width: 100%; margin: 0 1rem;">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Editar Cliente</h2>
            <input type="hidden" id="editClientId">
            <label class="form-label" for="editClientName">Nombre del negocio</label>
            <input type="text" id="editClientName" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <label class="form-label" for="editClientAddress">Direcci√≥n</label>
            <input type="text" id="editClientAddress" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <label class="form-label" for="editClientPhone">Tel√©fono</label>
            <input type="tel" id="editClientPhone" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <label class="form-label" for="editClientZone">Zona</label>
            <input type="text" id="editClientZone" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
            <button onclick="updateClient()" class="btn-success" style="width: 100%; font-size: 0.875rem; margin-bottom: 0.5rem;">Guardar Cambios</button>
            <button onclick="closeEditClientModal()" class="btn-primary" style="width: 100%; background: #6b7280; font-size: 0.875rem;">Cancelar</button>
        </div>
    </div>

    <!-- EDIT PREVENTISTA MODAL -->
    <div id="editPreventistaModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50;">
        <div class="card" style="max-width: 28rem; width: 100%; margin: 0 1rem;">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Editar Preventista</h2>
            <input type="hidden" id="editPreventistaId">
            <label class="form-label" for="editPreventistName">Nombre</label>
            <input type="text" id="editPreventistName" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <label class="form-label" for="editPreventistDni">DNI</label>
            <input type="text" id="editPreventistDni" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <label class="form-label" for="editPreventistPhone">Tel√©fono</label>
            <input type="text" id="editPreventistPhone" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <label class="form-label" for="editPreventistZone">Zona</label>
            <input type="text" id="editPreventistZone" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
            <p id="editPreventistEmail" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; background: #f3f4f6; padding: 0.5rem; border-radius: 0.375rem;"></p>
            <button onclick="updatePreventista()" class="btn-success" style="width: 100%; font-size: 0.875rem; margin-bottom: 0.5rem;">Guardar Cambios</button>
            <button onclick="closeEditPreventistaModal()" class="btn-primary" style="width: 100%; background: #6b7280; font-size: 0.875rem;">Cancelar</button>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50;">
        <div class="card" style="max-width: 28rem; width: 100%; margin: 0 1rem;">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Ingresar al Sistema</h2>
            <input type="text" id="loginEmail" placeholder="Email" oninput="checkAdminEmail()" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <input type="password" id="loginPassword" placeholder="Contrase√±a" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; font-size: 0.875rem;">
            <select id="loginRole" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
                <option value="admin" id="adminRoleOption">Administrador</option>
                <option value="preventista">Preventista</option>
            </select>
            <button onclick="handleLogin()" class="btn-primary" style="width: 100%; font-size: 0.875rem;">Ingresar</button>
            <p id="loginDemoText" style="font-size: 0.75rem; color: #6b7280; margin-top: 0.75rem; text-align: center; display: none;">Demo: email y contrase√±a pueden ser cualquiera</p>
        </div>
    </div>

    <!-- ALERTS -->
    <div id="alertBox"></div>

</main>

<script>
    // ====== CONFIGURACI√ìN DE SUPABASE ======
    const SUPABASE_URL = 'https://zxhsuicbuezyvmexahau.supabase.co';
    // IMPORTANTE: Reemplaza 'admin@example.com' con el email de tu √∫nica cuenta de administrador.
    const ADMIN_EMAIL = 'axelestudio2214@gmail.com'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4aHN1aWNidWV6eXZtZXhhaGF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjY2NDYsImV4cCI6MjA3ODU0MjY0Nn0.RUcH2zI271MqfRRA-_3NHbLwvXzopPnksEVxHsa2nDo';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== ESTADO GLOBAL ======
    let currentUser = null;
    let currentRole = null;
    let currentZone = null;
    let catalogProducts = []; // Cache de productos
    let preventistaProfile = null; // Cache del perfil del preventista
    let currentOrder = {}; // { producto_id: cantidad }
    let loadedOrders = []; // Cache para los pedidos cargados por el admin
    let allPreventistas = []; // Cache de preventistas para edici√≥n
    let allClients = []; // Cache de clientes para edici√≥n y b√∫squeda
    let allProducts = []; // Cache de productos para edici√≥n

    // ====== FUNCIONES AUXILIARES ======
    function formatCurrency(value) {
        if (typeof value !== 'number') {
            value = 0;
        }
        // Formatea el n√∫mero con separadores de miles (puntos) y 2 decimales.
        return value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&.');
    }

    function showAlert(message, type = 'success') {
        const alertBox = document.getElementById('alertBox');
        const bgColor = type === 'success' ? '#dcfce7' : '#fee2e2';
        const textColor = type === 'success' ? '#166534' : '#991b1b';
        const existingAlert = alertBox.querySelector('div');
        if (existingAlert) existingAlert.remove();

        alertBox.innerHTML = `
            <div style="background: ${bgColor}; color: ${textColor}; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <span>${message}</span>
                <button onclick="this.parentElement.style.display='none'" style="background: none; border: none; cursor: pointer; font-size: 1.25rem;">&times;</button>
            </div>
        `;
        setTimeout(() => {
            alertBox.innerHTML = '';
        }, 5000);
    }

    function switchTab(tabName) {
        // Ocultar todos los tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });

        // Mostrar tab seleccionado
        const tab = document.getElementById('tab-' + tabName);
        if (tab) tab.style.display = 'block';

        // Actualizar estilos de botones
        document.querySelectorAll('.adminTab, .prevTab').forEach(btn => {
            btn.classList.remove('tab-active');
            btn.classList.add('tab-inactive');
            btn.style.background = '#e5e7eb';
            btn.style.color = '#374151';
        });
        
        const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeBtn) {
            activeBtn.classList.remove('tab-inactive');
            activeBtn.classList.add('tab-active');
            activeBtn.style.background = '#4f46e5';
            activeBtn.style.color = 'white';
        }

        if (tabName === 'nuevo-pedido') {
            resetOrderForm();
        }
    }

    async function handleLogout() {
        const { error } = await supabase.auth.signOut();
        if (error) {
            showAlert('Error al cerrar sesi√≥n: ' + error.message, 'error');
        } else {
            localStorage.removeItem('appUserRole');
            window.location.reload(); // Recargar la p√°gina para un estado limpio
        }
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('preventistPassword');
        const toggleBtn = document.getElementById('togglePasswordBtn');
        
        // Cambiar el tipo de input
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleBtn.textContent = 'üôà';
        } else {
            passwordInput.type = 'password';
            toggleBtn.textContent = 'üëÅÔ∏è';
        }
    }

    function checkAdminEmail() {
        const emailInput = document.getElementById('loginEmail').value;
        const roleSelect = document.getElementById('loginRole');
        const adminOption = document.getElementById('adminRoleOption');

        if (emailInput.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
            // Si es el admin, mostrar la opci√≥n, seleccionarla y bloquear el selector
            adminOption.style.display = 'block';
            roleSelect.value = 'admin';
            roleSelect.disabled = true;
        } else {
            // Si no es el admin, ocultar la opci√≥n, seleccionar preventista y desbloquear el selector
            adminOption.style.display = 'none';
            roleSelect.value = 'preventista';
            roleSelect.disabled = false;
        }
    }

    // ====== FUNCIONES DE ADMIN ======
    async function addProduct() {
        const name = document.getElementById('productName').value;
        const price = parseFloat(document.getElementById('productPrice').value);
        const stock = parseInt(document.getElementById('productStock').value, 10);
        const imageUrl = document.getElementById('productImageUrl').value;

        if (!name || isNaN(price) || isNaN(stock)) {
            showAlert('Por favor completa nombre, precio y stock.', 'error');
            return;
        }

        try {
            // Intentar insertar en la tabla. Si falla por tabla no encontrada, mostrar instrucciones
            const { data, error } = await supabase.from('productos').insert([{
                nombre: name,
                precio: price,
                stock: stock,
                imagen_url: imageUrl || null
            }]);

            if (error) {
                if (error.message.includes('stock')) showAlert('‚ö†Ô∏è La columna "stock" no existe en la tabla "productos". Por favor, cr√©ala.', 'error');

                if (error.message.includes('table') && error.message.includes('schema cache')) {
                    showAlert('‚ö†Ô∏è La tabla "productos" no existe en Supabase. Por favor, crea la tabla con las columnas: nombre (text), precio (numeric). O usa otro nombre de tabla existente.', 'error');
                    return;
                }
                throw error;
            }

            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productImageUrl').value = '';
            showAlert('Producto agregado exitosamente');
            loadAdminData();
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    function showEditProductModal(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) {
            showAlert('No se encontr√≥ el producto para editar.', 'error');
            return;
        }

        document.getElementById('editProductId').value = product.id;
        document.getElementById('editProductName').value = product.nombre;
        document.getElementById('editProductPrice').value = product.precio;
        document.getElementById('editProductStock').value = product.stock;
        document.getElementById('editProductImageUrl').value = product.imagen_url || '';

        document.getElementById('editProductModal').style.display = 'flex';
    }

    function closeEditProductModal() {
        document.getElementById('editProductModal').style.display = 'none';
    }

    async function updateProduct() {
        const id = document.getElementById('editProductId').value;
        const name = document.getElementById('editProductName').value;
        const price = parseFloat(document.getElementById('editProductPrice').value);
        const stock = parseInt(document.getElementById('editProductStock').value, 10);
        const imageUrl = document.getElementById('editProductImageUrl').value;

        if (!name || isNaN(price) || isNaN(stock)) {
            showAlert('Por favor completa nombre, precio y stock.', 'error');
            return;
        }

        try {
            const { error } = await supabase
                .from('productos')
                .update({ nombre: name, precio: price, stock: stock, imagen_url: imageUrl || null })
                .eq('id', id);

            if (error) throw error;

            showAlert('Producto actualizado correctamente.');
            closeEditProductModal();
            loadAdminData(); // Recargar datos para ver los cambios
        } catch (error) {
            showAlert('Error al actualizar el producto: ' + error.message, 'error');
        }
    }

    async function deleteProduct(id, name) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar el producto "${name}"? Esta acci√≥n no se puede deshacer.`)) {
            return;
        }

        try {
            const { error } = await supabase
                .from('productos')
                .delete()
                .eq('id', id);

            if (error) throw error;

            showAlert(`Producto "${name}" eliminado correctamente.`);
            loadAdminData(); // Recargar la lista de productos
        } catch (error) {
            showAlert('Error al eliminar el producto: ' + error.message, 'error');
        }
    }

    async function addPreventista() {
        const name = document.getElementById('preventistName').value;
        const zone = document.getElementById('preventistZone').value;
        const dni = document.getElementById('preventistDni').value;
        const phone = document.getElementById('preventistPhone').value;
        const email = document.getElementById('preventistEmail').value;
        const password = document.getElementById('preventistPassword').value;

        if (!name || !zone || !email || !dni || !phone || !password) {
            showAlert('Por favor completa todos los campos', 'error');
            return;
        }
        
        // Validaci√≥n de la fortaleza de la contrase√±a
        const passwordErrors = [];
        if (password.length < 8) {
            passwordErrors.push('al menos 8 caracteres');
        }
        if (!/[a-z]/.test(password)) {
            passwordErrors.push('una letra min√∫scula');
        }
        if (!/[A-Z]/.test(password)) {
            passwordErrors.push('una letra may√∫scula');
        }
        if (!/[0-9]/.test(password)) {
            passwordErrors.push('un n√∫mero');
        }

        if (passwordErrors.length > 0) {
            showAlert(`La contrase√±a debe contener: ${passwordErrors.join(', ')}.`, 'error');
            return;
        }

        try {
            // Verificar si el DNI ya existe
            const { data: dniExists, error: dniError } = await supabase
                .from('preventistas')
                .select('id')
                .eq('dni', dni)
                .single();

            if (dniExists) {
                showAlert('Ya existe un preventista con el DNI ingresado.', 'error');
                return;
            }

            // Paso 1: Crear el usuario en Supabase Auth
            const { data: { user }, error: authError } = await supabase.auth.signUp({
                email,
                password: password
            });

            // Si hay un error de autenticaci√≥n (ej: el usuario ya existe), lo mostramos y detenemos.
            if (authError) {
                // Personalizamos el mensaje para que sea m√°s claro para el usuario.
                if (authError.message.includes('User already registered')) {
                    showAlert('El email ingresado ya est√° registrado en el sistema.', 'error');
                } else { showAlert(`Error de autenticaci√≥n: ${authError.message}`, 'error'); }
                return;
            }
            
            if (!user) {
                throw new Error('No se pudo crear o verificar el usuario de autenticaci√≥n.');
            }

            // Paso 2: Insertar el perfil del preventista con el user_id correcto
            const { error: insertError } = await supabase.from('preventistas').insert([{
                user_id: user.id, // Usar siempre el ID del usuario autenticado
                nombre: name,
                zona: zone.toUpperCase(),
                email: email,
                dni: dni,
                telefono: phone
            }]);

            if (insertError) throw insertError;

            document.getElementById('preventistName').value = '';
            document.getElementById('preventistZone').value = '';
            document.getElementById('preventistEmail').value = '';
            document.getElementById('preventistDni').value = '';
            document.getElementById('preventistPhone').value = '';
            document.getElementById('preventistPassword').value = '';
            
            showAlert(`Preventista ${name} creado en zona ${zone}`);
            loadAdminData();
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    function showEditPreventistaModal(preventistaId) {
        const preventista = allPreventistas.find(p => p.id === preventistaId);
        if (!preventista) {
            showAlert('No se encontr√≥ el preventista para editar.', 'error');
            return;
        }

        document.getElementById('editPreventistaId').value = preventista.id;
        document.getElementById('editPreventistName').value = preventista.nombre;
        document.getElementById('editPreventistDni').value = preventista.dni;
        document.getElementById('editPreventistPhone').value = preventista.telefono;
        document.getElementById('editPreventistZone').value = preventista.zona;
        document.getElementById('editPreventistEmail').textContent = `Email: ${preventista.email} (no se puede cambiar)`;

        document.getElementById('editPreventistaModal').style.display = 'flex';
    }

    function closeEditPreventistaModal() {
        document.getElementById('editPreventistaModal').style.display = 'none';
    }

    async function updatePreventista() {
        const id = document.getElementById('editPreventistaId').value;
        const name = document.getElementById('editPreventistName').value;
        const dni = document.getElementById('editPreventistDni').value;
        const phone = document.getElementById('editPreventistPhone').value;
        const zone = document.getElementById('editPreventistZone').value;

        if (!name || !zone || !dni || !phone) {
            showAlert('Por favor completa todos los campos.', 'error');
            return;
        }

        try {
            // Verificar si el DNI ya existe en OTRO preventista
            const { data: dniExists, error: dniError } = await supabase
                .from('preventistas')
                .select('id')
                .eq('dni', dni)
                .not('id', 'eq', id) // Excluir al preventista actual de la b√∫squeda
                .single();

            if (dniExists) {
                showAlert('El DNI ingresado ya pertenece a otro preventista.', 'error');
                return;
            }

            const { error } = await supabase
                .from('preventistas')
                .update({ nombre: name, dni: dni, telefono: phone, zona: zone.toUpperCase() })
                .eq('id', id);

            if (error) throw error;

            showAlert('Datos del preventista actualizados correctamente.');
            closeEditPreventistaModal();
            loadAdminData(); // Recargar datos para ver los cambios
        } catch (error) {
            showAlert('Error al actualizar el preventista: ' + error.message, 'error');
        }
    }

    async function deletePreventista(id, name) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar al preventista "${name}"? Esta acci√≥n no se puede deshacer.`)) {
            return;
        }

        try {
            // Llamar a la Edge Function para un borrado completo y seguro.
            const { data, error } = await supabase.functions.invoke('delete-preventista', {
                body: { preventista_id: id },
            });

            if (error) {
                // Si la funci√≥n de servidor devuelve un error, lo mostramos.
                throw new Error(data.error || error.message);
            }

            showAlert(`Preventista "${name}" eliminado correctamente.`);
            loadAdminData(); // Recargar la lista de preventistas
        } catch (error) {
            showAlert('Error al eliminar el preventista: ' + error.message, 'error');
        }
    }

    function showEditClientModal(clientId) {
        const client = allClients.find(c => c.id === clientId);
        if (!client) {
            showAlert('No se encontr√≥ el cliente para editar.', 'error');
            return;
        }

        document.getElementById('editClientId').value = client.id;
        document.getElementById('editClientName').value = client.nombre;
        document.getElementById('editClientAddress').value = client.direccion;
        document.getElementById('editClientPhone').value = client.telefono;
        document.getElementById('editClientZone').value = client.zona;

        document.getElementById('editClientModal').style.display = 'flex';
    }

    function closeEditClientModal() {
        document.getElementById('editClientModal').style.display = 'none';
    }

    async function updateClient() {
        const id = document.getElementById('editClientId').value;
        const name = document.getElementById('editClientName').value;
        const address = document.getElementById('editClientAddress').value;
        const phone = document.getElementById('editClientPhone').value;
        const zone = document.getElementById('editClientZone').value;

        if (!name || !address || !zone) {
            showAlert('Por favor completa nombre, direcci√≥n y zona.', 'error');
            return;
        }

        try {
            const { error } = await supabase
                .from('clientes')
                .update({ nombre: name, direccion: address, telefono: phone, zona: zone.toUpperCase() })
                .eq('id', id);

            if (error) throw error;

            showAlert('Datos del cliente actualizados correctamente.');
            closeEditClientModal();
            loadAdminData(); // Recargar datos para ver los cambios
        } catch (error) {
            showAlert('Error al actualizar el cliente: ' + error.message, 'error');
        }
    }

    async function deleteClient(id, name) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar al cliente "${name}"? Esta acci√≥n no se puede deshacer.`)) {
            return;
        }

        try {
            const { error } = await supabase
                .from('clientes')
                .delete()
                .eq('id', id);

            if (error) throw error;

            showAlert(`Cliente "${name}" eliminado correctamente.`);
            loadAdminData();
        } catch (error) {
            showAlert('Error al eliminar el cliente: ' + error.message, 'error');
        }
    }

    async function reassignClient(clientId) {
        const selectElement = document.getElementById(`reassign-select-${clientId}`);
        const newPreventistaUserId = selectElement.value;

        if (!newPreventistaUserId) {
            showAlert('Por favor, selecciona un preventista para reasignar.', 'error');
            return;
        }

        try {
            const { error } = await supabase
                .from('clientes')
                .update({ preventista_id: newPreventistaUserId })
                .eq('id', clientId);

            if (error) throw error;

            showAlert('Cliente reasignado correctamente.');
            loadAdminData(); // Recargar todos los datos para que el cliente desaparezca de esta lista
        } catch (error) {
            showAlert('Error al reasignar el cliente: ' + error.message, 'error');
        }
    }

    function showOrderModal(order) {
        try {
            if (!order) {
                showAlert('No se encontraron los datos del pedido.', 'error');
                return;
            }
            const boletaContent = document.getElementById('boletaContent');
            
            const itemsHtml = order.items.map(item => `
                <tr style="border-bottom: 1px solid #f3f4f6;">
                    <td style="padding: 0.5rem 0.25rem; text-align: center;">${item.cantidad}</td>
                    <td style="padding: 0.5rem 0.25rem;">${item.nombre}</td>
                    <td style="padding: 0.5rem 0.25rem; text-align: right;">$${formatCurrency(item.precio)}</td>
                    <td style="padding: 0.5rem 0.25rem; text-align: right; font-weight: 500;">$${formatCurrency(item.cantidad * item.precio)}</td>
                </tr>
            `).join('');

            boletaContent.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <p style="font-weight: 600;">Cliente:</p>
                        <p>${order.clientes?.nombre || 'Cliente no especificado'}</p>
                        <p style="color: #6b7280;">${order.clientes?.direccion || 'Sin direcci√≥n'}</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="font-weight: 600;">Pedido N¬∞: ${order.id}</p>
                        <p>Fecha: ${new Date(order.created_at).toLocaleDateString('es-AR')}</p>
                        <p>Preventista: ${order.preventistas?.nombre || 'N/A'}</p>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f3f4f6; text-align: left;">
                        <tr>
                            <th style="padding: 0.5rem 0.25rem; width: 15%; text-align: center;">Cant.</th>
                            <th style="padding: 0.5rem 0.25rem;">Descripci√≥n</th>
                            <th style="padding: 0.5rem 0.25rem; width: 25%; text-align: right;">P. Unit.</th>
                            <th style="padding: 0.5rem 0.25rem; width: 25%; text-align: right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div style="text-align: right; margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e5e7eb;">
                    <p style="font-size: 1.25rem; font-weight: bold;">Total: $${formatCurrency(order.total)}</p>
                </div>
            `;

            document.getElementById('boletaModal').style.display = 'flex';
        } catch (error) {
            showAlert(`Error al mostrar la boleta: ${error.message}`, 'error');
        }
    }

    function createRoute() {
        showAlert('Funci√≥n de rutas disponible en pr√≥xima actualizaci√≥n');
    }

    function closeBoletaModal() {
        document.getElementById('boletaModal').style.display = 'none';
    }

    async function loadAdminData() {
        try {
            // Cargar productos
            allProducts = (await supabase.from('productos').select('*')).data || [];
            const { data: productos } = await supabase.from('productos').select('*');
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = (productos || []).map(p => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb;">
                    <img src="${p.imagen_url || 'https://via.placeholder.com/64'}" alt="${p.nombre}" style="width: 64px; height: 64px; object-fit: cover; border-radius: 0.375rem; background: #e5e7eb;">
                    <div style="flex-grow: 1;">
                        <p style="font-weight: 600; margin: 0;">${p.nombre}</p>
                        <p style="color: #16a34a; font-weight: bold; margin: 0.25rem 0 0 0;">$${formatCurrency(p.precio)}</p>
                    </div>
                    <div>
                        <p style="font-size: 0.75rem; color: #6b7280; margin: 0; text-align: right;">Stock</p>
                        <p style="font-weight: bold; font-size: 1.125rem; margin: 0; text-align: right; color: ${p.stock <= 10 ? '#b91c1c' : '#1e40af'};">${p.stock || 0}</p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; flex-shrink: 0;">
                        <button onclick="showEditProductModal(${p.id})" class="btn-primary" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Editar</button>
                        <button onclick="deleteProduct(${p.id}, '${p.nombre.replace(/'/g, "\\'")}')" class="btn-danger" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Eliminar</button>
                    </div>
                </div>
            `).join('') || '<p style="color: #6b7280;">Sin productos</p>';

            // Cargar clientes
            const { data: clientes } = await supabase.from('clientes').select('*');
            allClients = clientes || []; // Guardar en cache para edici√≥n y b√∫squeda
            renderClientsList(allClients);

            // Cargar y renderizar clientes sin asignar
            const unassignedClients = allClients.filter(c => !c.preventista_id);
            const unassignedClientsList = document.getElementById('unassignedClientsList');
            const preventistaOptions = (allPreventistas || []).map(p => `<option value="${p.user_id}">${p.nombre} (${p.zona})</option>`).join('');

            unassignedClientsList.innerHTML = unassignedClients.map(c => `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb;">
                    <div style="flex-grow: 1;">
                        <p style="font-weight: 600; margin: 0;">${c.nombre}</p>
                        <p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.8rem;">${c.direccion}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0;">
                        <select id="reassign-select-${c.id}" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.75rem;">
                            <option value="">-- Reasignar a --</option>
                            ${preventistaOptions}
                        </select>
                        <button onclick="reassignClient(${c.id})" class="btn-success" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Reasignar</button>
                    </div>
                </div>
            `).join('') || '<p style="color: #6b7280;">No hay clientes sin asignar.</p>';

            // Cargar preventistas
            const { data: preventistas } = await supabase.from('preventistas').select('*');
            allPreventistas = preventistas || []; // Guardar en cache para edici√≥n
            const preventistasList = document.getElementById('preventistasList');
            preventistasList.innerHTML = (preventistas || []).map(p => `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb;">
                    <div>
                        <p style="font-weight: 600; margin: 0;">${p.nombre}</p>
                        <p style="color: #4f46e5; font-weight: bold; margin: 0.25rem 0 0 0;">Zona: ${p.zona || 'N/A'}</p>
                        <p style="color: #6b7280; font-size: 0.8rem; margin: 0.25rem 0 0 0;">DNI: ${p.dni || 'N/A'} | Tel: ${p.telefono || 'N/A'}</p>
                        <p style="color: #6b7280; font-size: 0.8rem; margin: 0.25rem 0 0 0;">${p.email || 'N/A'}</p>
                    </div>
                    <div>
                        <button onclick="showEditPreventistaModal(${p.id})" class="btn-primary" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; margin-bottom: 0.5rem; width: 100%;">Editar</button>
                        <button onclick="deletePreventista(${p.id}, '${p.nombre.replace(/'/g, "\\'")}')" class="btn-danger" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; width: 100%;">Eliminar</button>
                    </div>
                </div>
            `).join('') || '<p style="color: #6b7280;">Sin preventistas</p>';

            // Actualizar select
            const select = document.getElementById('routePreventistaSelect');
            select.innerHTML = '<option value="">-- Seleccionar --</option>' + 
                (preventistas || []).map(p => `<option value="${p.id}">${p.nombre} (${p.zona})</option>`).join('');

            // Crear un mapa de preventistas para buscar nombres f√°cilmente
            const preventistaMap = (preventistas || []).reduce((map, p) => {
                map[p.user_id] = p.nombre;
                return map;
            }, {});

            // Cargar pedidos
            const { data: pedidos, error: pedidosError } = await supabase
                .from('pedidos')
                .select('*, clientes(*)') // Se quita la relaci√≥n directa con preventistas
                .order('created_at', { ascending: false });

            if (pedidosError) throw pedidosError;

            // Guardar pedidos en el cache
            loadedOrders = (pedidos || []).map(o => {
                const preventistaNombre = preventistaMap[o.preventista_id] || 'N/A';
                return { ...o, preventistas: { nombre: preventistaNombre } };
            });

            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = loadedOrders.map(o => {
                return `
                    <div style="padding: 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb; display: grid; grid-template-columns: 4fr 1fr; gap: 1rem; align-items: center;">
                        <div>
                            <p style="font-weight: 600; margin: 0;">Pedido #${o.id} - <span style="color: #4338ca;">${o.clientes?.nombre || 'Cliente no encontrado'}</span></p>
                            <p style="margin: 0.25rem 0 0 0; color: #6b7280;">Preventista: ${o.preventistas.nombre} | Zona: ${o.zona}</p>
                            <p style="margin: 0.25rem 0 0 0; font-weight: 600;">Total: $${formatCurrency(o.total)}</p>
                        </div>
                        <button onclick='showOrderModal(loadedOrders.find(p => p.id === ${o.id}))' class="btn-primary" style="padding: 0.5rem; font-size: 0.75rem;">üìÑ Ver Boleta</button>
                    </div>
                `;
            }).join('') || '<p style="color: #6b7280;">Sin pedidos</p>';

            // Cargar datos del dashboard (Resumen)
            const LOW_STOCK_THRESHOLD = 10;

            // -- Ventas --
            const now = new Date();
            const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const weeklySales = (pedidos || [])
                .filter(p => new Date(p.created_at) >= oneWeekAgo)
                .reduce((sum, p) => sum + p.total, 0);

            const monthlySales = (pedidos || [])
                .filter(p => new Date(p.created_at) >= startOfMonth)
                .reduce((sum, p) => sum + p.total, 0);

            document.getElementById('weeklySales').textContent = `$${formatCurrency(weeklySales)}`;
            document.getElementById('monthlySales').textContent = `$${formatCurrency(monthlySales)}`;

            // -- Inventario y Alertas --
            const lowStockProducts = (productos || []).filter(p => p.stock <= LOW_STOCK_THRESHOLD);
            const lowStockList = document.getElementById('lowStockList');
            if (lowStockProducts.length > 0) {
                lowStockList.innerHTML = lowStockProducts.map(p => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">
                        <span>${p.nombre}</span>
                        <span style="font-weight: bold; color: #b91c1c;">${p.stock}</span>
                    </div>
                `).join('');
            } else {
                lowStockList.innerHTML = '<p style="color: #6b7280;">No hay productos con bajo stock.</p>';
            }

            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="text-align: left; border-bottom: 2px solid #d1d5db;">
                        <tr>
                            <th style="padding: 0.5rem;">Producto</th>
                            <th style="padding: 0.5rem; text-align: right;">Stock Actual</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(productos || []).map(p => `
                            <tr style="border-bottom: 1px solid #f3f4f6;">
                                <td style="padding: 0.5rem;">${p.nombre}</td>
                                <td style="padding: 0.5rem; text-align: right; font-weight: 600; color: ${p.stock <= LOW_STOCK_THRESHOLD ? '#b91c1c' : '#374151'};">
                                    ${p.stock || 0}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            showAlert('Error cargando datos del admin: ' + error.message, 'error');
        }
    }

    function renderClientsList(clients) {
        const clientsList = document.getElementById('clientsList');
        clientsList.innerHTML = (clients || []).map(c => `
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb;">
                <div style="flex-grow: 1;">
                    <p style="font-weight: 600; margin: 0;">${c.nombre}</p>
                    <p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.8rem;">${c.direccion}</p>
                    <p style="color: #4f46e5; font-weight: bold; margin: 0.25rem 0 0 0;">Zona: ${c.zona}</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; flex-shrink: 0;">
                    <button onclick="showEditClientModal(${c.id})" class="btn-primary" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Editar</button>
                    <button onclick="deleteClient(${c.id}, '${c.nombre.replace(/'/g, "\\'")}')" class="btn-danger" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Eliminar</button>
                </div>
            </div>
        `).join('') || '<p style="color: #6b7280;">Sin clientes</p>';
    }

    function filterClients() {
        const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
        const filteredClients = allClients.filter(c => 
            c.nombre.toLowerCase().includes(searchTerm) || 
            (c.zona && c.zona.toLowerCase().includes(searchTerm))
        );
        renderClientsList(filteredClients);
    }

    function filterProducts() {
        const searchTerm = document.getElementById('productSearch').value.toLowerCase();
        const filteredProducts = catalogProducts.filter(p => p.nombre.toLowerCase().includes(searchTerm));
        renderOrderCatalog(filteredProducts);
    }

    function updateOrder(productId, quantity) {
        quantity = parseInt(quantity, 10);
        if (isNaN(quantity) || quantity < 0) {
            quantity = 0;
        }

        if (quantity > 0) {
            currentOrder[productId] = quantity;
        } else {
            delete currentOrder[productId];
        }
        updateOrderSummary();
    }

    function updateOrderSummary() {
        const summaryList = document.getElementById('orderSummaryList');
        const orderTotalEl = document.getElementById('orderTotal');
        let total = 0;
        let summaryHTML = '';

        for (const productId in currentOrder) {
            const product = catalogProducts.find(p => p.id == productId);
            const quantity = currentOrder[productId];
            if (product && quantity > 0) {
                const subtotal = product.precio * quantity;
                total += subtotal;
                summaryHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0;">
                        <div>
                            <p style="margin: 0; font-weight: 500;">${product.nombre}</p>
                            <p style="margin: 0; color: #6b7280; font-size: 0.75rem;">${quantity} x $${formatCurrency(product.precio)}</p>
                        </div>
                        <p style="margin: 0; font-weight: 600;">$${formatCurrency(subtotal)}</p>
                    </div>
                `;
            }
        }

        if (summaryHTML === '') {
            summaryHTML = '<p style="color: #6b7280;">Agrega productos del cat√°logo.</p>';
        }

        summaryList.innerHTML = summaryHTML;
        orderTotalEl.textContent = `$${formatCurrency(total)}`;
    }

    function resetOrderForm() {
        currentOrder = {};
        updateOrderSummary();
        document.getElementById('productSearch').value = '';
        if (document.getElementById('orderClientSelect').options.length > 0) {
            document.getElementById('orderClientSelect').selectedIndex = 0;
        }
        renderOrderCatalog(catalogProducts);
    }

    async function submitOrder() {
        const clienteId = document.getElementById('orderClientSelect').value;
        const items = Object.entries(currentOrder).map(([productId, quantity]) => {
            const product = catalogProducts.find(p => p.id == productId);
            return {
                producto_id: product.id,
                nombre: product.nombre,
                cantidad: quantity,
                precio: product.precio,
            };
        });

        if (!clienteId) {
            showAlert('Por favor, selecciona un cliente.', 'error');
            return;
        }

        if (items.length === 0) {
            showAlert('El pedido est√° vac√≠o. Agrega al menos un producto.', 'error');
            return;
        }

        const productWithNoStock = items.find(item => {
            const product = catalogProducts.find(p => p.id === item.producto_id);
            return product.stock < item.cantidad;
        });

        if (productWithNoStock) {
            showAlert(`No hay stock suficiente para "${productWithNoStock.nombre}". Stock disponible: ${catalogProducts.find(p => p.id === productWithNoStock.producto_id).stock}.`, 'error');
            return;
        }

        const total = items.reduce((sum, item) => sum + item.cantidad * item.precio, 0);

        try {
            const { data, error } = await supabase.from('pedidos').insert([{
                preventista_id: currentUser.id,
                cliente_id: clienteId,
                total: total,
                items: items, // Guardamos los productos como JSON
                estado: 'pendiente',
                zona: currentZone // A√±adir la zona del preventista
            }]).select();

            if (error) throw error;

            // Descontar stock
            for (const item of items) {
                const product = catalogProducts.find(p => p.id === item.producto_id);
                const newStock = product.stock - item.cantidad;
                await supabase.from('productos').update({ stock: newStock }).eq('id', item.producto_id);
            }

            showAlert(`Pedido #${data[0].id} creado exitosamente.`);
            resetOrderForm();
            loadPreventistaData(); // Recargar datos para ver el nuevo pedido en "Mis Pedidos"
            switchTab('mis-pedidos');

        } catch (error) {
            showAlert('Error al crear el pedido: ' + error.message, 'error');
        }
    }

    function renderOrderCatalog(products) {
        const orderCatalogList = document.getElementById('orderCatalogList');
        orderCatalogList.innerHTML = (products || []).map(p => `
            <div style="border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column;">
                <img src="${p.imagen_url || 'https://via.placeholder.com/150'}" alt="${p.nombre}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 0.375rem 0.375rem 0 0; background: #e5e7eb;">
                <div style="padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between;">
                    <p style="font-weight: 600; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.nombre}</p>
                    <p style="color: #16a34a; font-weight: bold; margin: 0.25rem 0;">$${formatCurrency(p.precio)} <span style="color: #6b7280; font-weight: 500; font-size: 0.75rem;">(Stock: ${p.stock || 0})</span></p>
                </div>
                <div style="display: flex; align-items: center; margin-top: 0.5rem; padding: 0 0.75rem 0.75rem;">
                    <label for="qty-${p.id}" style="font-size: 0.75rem; margin-right: 0.5rem;">Cant:</label>
                    <input type="number" id="qty-${p.id}" min="0" value="${currentOrder[p.id] || 0}" onchange="updateOrder(${p.id}, this.value)" 
                           style="width: 100%; padding: 0.25rem 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                </div>
            </div>
        `).join('') || '<p style="color: #6b7280;">No se encontraron productos.</p>';
    }

    // ====== FUNCIONES DE PREVENTISTA ======
    async function createClient() {
        const name = document.getElementById('newClientName').value;
        const address = document.getElementById('newClientAddress').value;
        const phone = document.getElementById('newClientPhone').value;

        if (!name || !address) {
            showAlert('Por favor completa nombre y direcci√≥n', 'error');
            return;
        }

        try {
            const { error } = await supabase.from('clientes').insert([{
                nombre: name,
                direccion: address,
                telefono: phone || '',
                zona: currentZone,
                preventista_id: currentUser.id
            }]);

            if (error) throw error;

            document.getElementById('newClientName').value = '';
            document.getElementById('newClientAddress').value = '';
            document.getElementById('newClientPhone').value = '';
            document.getElementById('preventistDni').value = '';
            document.getElementById('preventistName').value = '';
            document.getElementById('preventistPhone').value = '';
            
            showAlert('Cliente creado exitosamente');
            loadPreventistaData();
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    async function loadPreventistaData() {
        try {
            // Cargar perfil del preventista
            const { data: profile, error: profileError } = await supabase
                .from('preventistas')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            if (profileError || !profile) {
                showAlert('No se pudo cargar tu perfil de preventista. Por favor, intenta iniciar sesi√≥n de nuevo.', 'error');
                await handleLogout(); // Forzar cierre de sesi√≥n si el perfil no existe
                return;
            }
            preventistaProfile = profile;


            const profileDetails = document.getElementById('myProfileDetails');
            profileDetails.innerHTML = `
                <p><strong>Nombre:</strong> ${preventistaProfile.nombre}</p>
                <p><strong>Email:</strong> ${preventistaProfile.email}</p>
                <p><strong>DNI:</strong> ${preventistaProfile.dni}</p>
                <p><strong>Tel√©fono:</strong> ${preventistaProfile.telefono}</p>
                <p><strong>Zona Asignada:</strong> ${preventistaProfile.zona}</p>`;

            // Cargar productos para el cat√°logo y cachearlos
            const { data: productos } = await supabase.from('productos').select('*');
            catalogProducts = productos || [];

            // Renderizar cat√°logo completo en su pesta√±a
            const catalogoList = document.getElementById('catalogoList');
            catalogoList.innerHTML = catalogProducts.map(p => `
                <div style="border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    <img src="${p.imagen_url || 'https://via.placeholder.com/150'}" alt="${p.nombre}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 0.375rem 0.375rem 0 0; background: #e5e7eb;">
                    <div style="padding: 0.75rem;">
                        <p style="font-weight: 600; margin: 0;">${p.nombre}</p>
                        <p style="color: #16a34a; font-weight: bold; margin: 0.25rem 0 0 0;">$${formatCurrency(p.precio)}</p>
                    </div>
                </div>
            `).join('') || '<p style="color: #6b7280;">Sin productos</p>';

            // Renderizar cat√°logo para la toma de pedidos
            renderOrderCatalog(catalogProducts);

            // Cargar clientes del preventista para el selector de pedidos
            const { data: misClientes } = await supabase.from('clientes').select('id, nombre').eq('preventista_id', currentUser.id);
            const clientSelect = document.getElementById('orderClientSelect');
            clientSelect.innerHTML = '<option value="">-- Seleccionar Cliente --</option>' + 
                (misClientes || []).map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');

            // Cargar mis pedidos
            const { data: misPedidos, error: pedidosError } = await supabase
                .from('pedidos')
                .select('id, created_at, total, estado, clientes ( nombre )')
                .eq('preventista_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (pedidosError) throw pedidosError;

            const myOrdersList = document.getElementById('myOrdersList');
            myOrdersList.innerHTML = (misPedidos || []).map(o => `
                <div style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <p style="font-weight: 600; margin: 0;">Pedido #${o.id} - ${o.clientes.nombre}</p>
                        <p style="font-weight: bold; margin: 0; color: ${o.estado === 'pendiente' ? '#b45309' : '#16a34a'};">${o.estado.toUpperCase()}</p>
                    </div>
                    <p style="margin: 0.25rem 0 0 0;">Fecha: ${new Date(o.created_at).toLocaleDateString()}</p>
                    <p style="margin: 0.25rem 0 0 0; font-weight: 600;">Total: $${formatCurrency(o.total)}</p>
                </div>
            `).join('') || '<p style="color: #6b7280;">No has realizado pedidos.</p>';

            // Cargar mis clientes
            const myClientsList = document.getElementById('myClientsList');
            myClientsList.innerHTML = (misClientes || []).map(c => `
                <div style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb;">
                    <p style="font-weight: 600; margin: 0;">${c.nombre}</p>
                </div>
            `).join('') || '<p style="color: #6b7280;">No tienes clientes asignados.</p>';

        } catch (error) {
            showAlert(`Error cargando tus datos: ${error.message}`, 'error');
            // Si hay un error grave cargando datos, es mejor cerrar la sesi√≥n para evitar inconsistencias.
            if (currentUser) {
                await handleLogout();
            }
        }
    }

    // ====== AUTENTICACI√ìN ======
    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const role = document.getElementById('loginRole').value;

        if (!email || !password) {
            showAlert('Por favor, ingresa tu email y contrase√±a.', 'error');
            return;
        }

        // Verificaci√≥n de seguridad: si el rol es admin, el email DEBE coincidir.
        if (role === 'admin' && email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
            showAlert('Este usuario no tiene permisos de administrador.', 'error');
            return;
        }

        try {
            const { data: { user }, error: authError } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (authError) throw authError;

            if (user) {
                currentRole = role;
                currentUser = user;
                localStorage.setItem('appUserRole', role); // Guardar el rol

                if (role === 'preventista') {
                    const { data: profile, error: profileError } = await supabase.from('preventistas').select('zona').eq('user_id', user.id).single();
                    if (profileError || !profile) throw new Error('Este usuario no es un preventista v√°lido.');
                    currentZone = profile.zona;
                } else {
                    // Para el admin, la zona no es relevante de la misma manera
                    currentRole = 'admin';
                    currentZone = 'ADMIN';
                }

                updateUI();
            } else {
                showAlert('No se pudo iniciar sesi√≥n. Revisa tus credenciales.', 'error');
            }
        } catch (error) {
            showAlert(`Error al iniciar sesi√≥n: ${error.message}`, 'error');
        }
    }

    function updateUI() {
        // Actualizar encabezado
        const isLoggedIn = !!currentUser;
        document.getElementById('userDisplay').textContent = `Usuario: ${currentUser?.email || 'An√≥nimo'}`;
        document.getElementById('roleDisplay').textContent = `Rol: ${currentRole === 'admin' ? 'üë®‚Äçüíº ADMINISTRADOR' : 'üöó PREVENTISTA ' + (currentZone || '')}`;
        document.getElementById('logoutButton').style.display = isLoggedIn ? 'inline-block' : 'none';
        
        // Mostrar/ocultar vistas
        document.getElementById('loginModal').style.display = isLoggedIn ? 'none' : 'flex';
        document.getElementById('adminView').style.display = currentRole === 'admin' ? 'block' : 'none';
        document.getElementById('preventistaView').style.display = currentRole === 'preventista' ? 'block' : 'none';

        // Cargar datos
        if (currentRole === 'admin') {
            switchTab('resumen'); // Iniciar en la pesta√±a de resumen
            loadAdminData();
        } else if (currentRole === 'preventista') {
            switchTab('nuevo-pedido'); // Iniciar en la pesta√±a de nuevo pedido
            loadPreventistaData();
        }
    }

    async function initializeApp() {
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
            currentUser = session.user;
            currentRole = localStorage.getItem('appUserRole');

            if (!currentRole) {
                // Si no hay rol, forzar cierre de sesi√≥n para evitar un estado inconsistente
                await handleLogout();
                return;
            }

            if (currentRole === 'preventista') {
                const { data: profile } = await supabase.from('preventistas').select('zona').eq('user_id', currentUser.id).single();
                currentZone = profile?.zona || null;
            }
        }
        updateUI();
    }

    // Inicializar
    window.addEventListener('load', () => {
        checkAdminEmail(); // Comprobar por si el navegador autocompleta el email
        initializeApp();
    });
</script>

</body>
</html>
